<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Card Identifier Extractor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar styling for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #a7f3d0; /* emerald-200 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f3f4f6; /* gray-100 */
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Modal Backdrop (Removed, but keeping for structural memory if needed later) */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="bg-white shadow-2xl rounded-xl w-full max-w-4xl p-6 md:p-10 transition-all duration-300">
        <h1 class="4xl font-extrabold text-emerald-600 mb-2">Multi-Card Identifier Extractor</h1>
        <p class="text-gray-500 mb-6 border-b pb-4">Capture an image containing up to 4 cards to extract data simultaneously.</p>

        <!-- User/Auth Info -->
        <div class="mb-6 bg-emerald-50 p-3 rounded-lg text-sm text-emerald-800">
            <p><strong>App ID:</strong> <span id="app-id">...</span></p>
            <p><strong>User ID:</strong> <span id="user-id">Authenticating...</span></p>
            <!-- DEVICE INFO DISPLAY -->
            <p class="mt-2 text-xs text-emerald-700 font-semibold">
                Device Info (for Auditing): <span id="device-info-display" class="font-normal">Loading...</span>
            </p>
        </div>
        
        <!-- Loading and Error Display -->
        <div id="error-message" class="text-center py-4 text-red-600 bg-red-100 rounded-lg hidden mb-4"></div>


        <!-- Input Form (Image-Based) -->
        <div class="flex flex-col gap-4 mb-8 p-4 border rounded-xl bg-emerald-50 shadow-inner">
            <h3 class="text-2xl font-bold text-emerald-700">Step 1 - Capture Image with Camera</h3>
            
            <!-- File Input (accepts camera capture - KEY FOR MOBILE) -->
            <label for="image-file-input" class="cursor-pointer bg-white hover:bg-gray-50 text-emerald-700 font-semibold py-3 px-6 rounded-lg border border-emerald-300 shadow-md transition duration-150 flex items-center justify-center space-x-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.808-1.212A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.808 1.212a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>Tap to Open Camera or Select File</span>
            </label>
            <input type="file" id="image-file-input" accept="image/*" capture="camera" 
                   class="hidden">
            
            <!-- Image Preview -->
            <div id="image-preview-container" class="mt-2 hidden bg-gray-100 p-2 rounded-lg">
                <img id="image-preview" class="max-w-full h-auto rounded-lg shadow-lg max-h-64 object-contain mx-auto transition-opacity duration-300" alt="Image Preview">
            </div>

            <button id="process-image-button" onclick="processImageForNumbers()" disabled
                    class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 disabled:bg-gray-400 flex items-center justify-center">
                2. Extract ALL Cards (Identifier, Barcode, Date)
            </button>
            
            <!-- Loading Indicator for Image Processing -->
            <div id="loading-indicator" class="text-center py-4 text-emerald-500 hidden border-t border-emerald-200 pt-4">
                <svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span id="loading-message">Initializing...</span>
            </div>
        </div>

        <!-- Extracted Data Area -->
        <div id="extraction-result-area" class="mt-6 mb-8 p-4 border rounded-xl bg-gray-100 shadow-md">
            <h3 class="2xl font-bold text-gray-700 mb-3">3. Extracted Cards Ready to Save</h3>
            <div id="extracted-display" class="min-h-[50px] p-3 bg-white border border-dashed border-gray-300 rounded-lg text-gray-600 whitespace-pre-wrap text-sm font-mono break-all space-y-2">
                <p><strong>Cards Found:</strong> <span id="display-card-count" class="font-mono text-gray-800 font-semibold">---</span></p>
                <p id="display-status" class="text-xs text-gray-500 italic">Upload an image of 1-4 cards to begin extraction.</p>
            </div>
            
            <button id="save-extracted-button" onclick="saveExtractedNumbers()" disabled
                    class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150 disabled:bg-gray-400 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v8"></path></svg>
                Save <span id="save-count">0</span> Card(s) to Firestore
            </button>
        </div>


        <!-- Action and Status Area -->
        <div class="flex justify-between items-center mb-6 border-t pt-4">
            <h2 class="text-2xl font-bold text-gray-700">Recorded Data (<span id="count">0</span>)</h2>
            
            <!-- UPDATED: Direct Download Button -->
            <button id="export-button" onclick="triggerCSVDownload()" disabled
                    class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 disabled:bg-gray-400 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Download CSV
            </button>
        </div>


        <!-- Data List -->
        <div id="numbers-list-container" class="bg-gray-100 p-4 rounded-lg max-h-96 overflow-y-auto custom-scrollbar border-t">
            <ul id="numbers-list" class="space-y-3">
                <li id="empty-state" class="text-gray-500 text-center py-4">No data recorded yet.</li>
            </ul>
        </div>
    </div>
    
    <!-- NOTE: CSV Preview Modal HTML was removed as requested -->

    <!-- Firebase Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            addDoc, 
            onSnapshot,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONSTANTS ---
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
        
        // ====================================================================================
        // 1. GEMINI API KEY (Used for image processing)
        // ====================================================================================
        const apiKey = "AIzaSyCA4MpL1N3GpJohJbc6zbjb6C4cEEvqUI0"; // NOTE: Left blank as per instruction for platform injection.

        // --- GLOBAL VARIABLES (MANDATORY Canvas Environment Checks) ---
        // MANDATORY: Check for __app_id or use fallback
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // MANDATORY: Check for __initial_auth_token or use fallback
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        // ====================================================================================
        // 2. FIREBASE CONFIGURATION (MANDATORY Canvas Environment Checks)
        // ====================================================================================
        
        // Default configuration based on user's previous hardcoded values, used if the 
        // environment variable __firebase_config is not available or fails to parse.
        const defaultFirebaseConfig = { 
            apiKey: "AIzaSyCA4MpL1N3GpJohJbc6zbjb6C4cEEvqUI0",
            authDomain: "iposimageatext.firebaseapp.com",
            projectId: "iposimageatext",
            storageBucket: "iposimageatext.appspot.com",
            messagingSenderId: "1022934110795",
            appId: "1:1022934110795:web:db87f7d00ba3f4e8524f7a",
            measurementId: "G-123YWKHX6"
        };
        
        let firebaseConfig = defaultFirebaseConfig;

        // MANDATORY: Check for __firebase_config or use fallback
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Failed to parse __firebase_config. Using default config.", e);
            }
        }
        
        // --- APP STATE ---
        let app;
        let db;
        let auth;
        let userId = null;
        let recordedData = []; 
        let extractedData = null; // Will now hold an ARRAY of extracted card objects
        
        // --- DOM ELEMENTS ---
        const imageFileInput = document.getElementById('image-file-input');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const processImageButton = document.getElementById('process-image-button');
        const saveExtractedButton = document.getElementById('save-extracted-button');
        const saveCountSpan = document.getElementById('save-count');
        const exportButton = document.getElementById('export-button');
        const numbersList = document.getElementById('numbers-list');
        const emptyState = document.getElementById('empty-state');
        const countSpan = document.getElementById('count');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingMessage = document.getElementById('loading-message');
        const errorDiv = document.getElementById('error-message');
        const deviceInfoDisplay = document.getElementById('device-info-display');
        
        // Updated Display Elements for Multi-Card summary
        const displayCardCount = document.getElementById('display-card-count');
        const displayStatus = document.getElementById('display-status');

        // Display initial IDs
        document.getElementById('app-id').textContent = appId;
        
        // Attach event listener for initial image selection
        imageFileInput.addEventListener('change', (e) => handleImageSelection(e));
        
        // Initial Display Reset
        function resetDisplay() {
            displayCardCount.textContent = '---';
            displayStatus.textContent = 'Awaiting new extraction.';
            saveExtractedButton.disabled = true;
            saveCountSpan.textContent = '0';
            extractedData = null; // Clear array
        }
        
        // --- DEVICE METADATA ---
        let deviceMetadata = {};

        // Helper function to get a concise OS name from the User Agent
        function getConciseOS(userAgent) {
            if (userAgent.match(/Android (\d+(\.\d+)?)/i)) {
                return 'Android ' + (userAgent.match(/Android (\d+(\.\d+)?)/i)[1] || '');
            }
            // Match iOS version (e.g., OS 17_0_3)
            if (userAgent.match(/(iPhone|iPad).*OS (\d+_\d+)/i)) {
                return 'iOS ' + (userAgent.match(/(iPhone|iPad).*OS (\d+_\d+)/i)[2] || '').replace(/_/g, '.');
            }
            // Match Windows version (e.g., Windows NT 10.0 for 10/11)
            if (userAgent.match(/Windows NT (\d+\.\d+)/i)) {
                const version = userAgent.match(/Windows NT (\d+\.\d+)/i)[1];
                const versionMap = { '10.0': '10/11', '6.3': '8.1', '6.2': '8', '6.1': '7' };
                return 'Windows ' + (versionMap[version] || 'PC');
            }
            if (userAgent.includes('Macintosh')) {
                return 'macOS';
            }
            // Fallback for Linux, etc.
            if (userAgent.includes('Linux')) {
                return 'Linux';
            }
            return 'Unknown OS';
        }

        function captureDeviceMetadata() {
            // Get User Agent (Device/OS/Browser Info)
            const userAgent = navigator.userAgent;
            
            // Get Screen Resolution
            const screenResolution = `${window.screen.width}x${window.screen.height}`;
            
            deviceMetadata = {
                userAgent: userAgent,
                screenResolution: screenResolution
            };

            // Update UI with summarized device info
            const conciseOS = getConciseOS(userAgent);
            deviceInfoDisplay.textContent = `${conciseOS} (${screenResolution})`;
        }


        // -------------------------------------------------------------------
        // 1. FIREBASE INITIALIZATION AND AUTHENTICATION
        // -------------------------------------------------------------------

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Capture metadata immediately on load
            captureDeviceMetadata(); 

            // Initial call to show loading while firebase auth completes
            showLoading("Initializing Firebase...");

            // Generate a fallback ID using crypto.randomUUID or a simpler fallback
            const fallbackUserId = (typeof crypto !== 'undefined' && crypto.randomUUID) 
                                   ? crypto.randomUUID() 
                                   : 'fallback-' + Math.random().toString(36).substring(2, 15);

            
            // Set up Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Successful login via token
                    userId = user.uid;
                    document.getElementById('user-id').textContent = `${userId} (Authenticated)`;
                    console.log("Authentication successful, user ID set:", userId);
                    hideLoading();
                    setupRealtimeListener();
                    resetDisplay();
                } else {
                    // If no user is logged in, attempt login if token exists, or fall back immediately.
                    if (initialAuthToken) {
                        try {
                            // Try Custom Token (Canvas default)
                            await signInWithCustomToken(auth, initialAuthToken);
                            // If successful, the listener will fire again with a 'user' object.
                        } catch (error) {
                            // Custom token failed
                            console.error("Custom Token Authentication Failed:", error);
                            
                            // Fallback: Proceed with a non-authenticated placeholder user ID
                            userId = fallbackUserId;
                            document.getElementById('user-id').textContent = `${userId} (CUSTOM TOKEN FAILED FALLBACK)`;
                            displayError(`Custom Token authentication failed. Proceeding with unauthenticated ID. Error: ${error.message}`);

                            hideLoading();
                            setupRealtimeListener();
                            resetDisplay();
                        }
                    } else {
                        // **FIX: Bypass the Anonymous sign-in attempt entirely to avoid the GCloud API error.**
                        console.warn("No Custom Auth Token provided. Bypassing Anonymous sign-in attempt to avoid external configuration errors.");
                        userId = fallbackUserId;
                        document.getElementById('user-id').textContent = `${userId} (UNAUTHENTICATED FALLBACK)`;

                        hideLoading();
                        setupRealtimeListener();
                        resetDisplay();
                    }
                }
                
                // Ensure buttons are active once we have a userId (even if fallback)
                processImageButton.disabled = imageFileInput.files.length === 0;
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            displayError("Failed to initialize Firebase. Check your configuration keys and project setup.");
        }
        
        // Utility Functions
        function showLoading(message) {
            loadingMessage.textContent = message;
            loadingIndicator.classList.remove('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        function displayError(message) {
            errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
            errorDiv.classList.remove('hidden');
            hideLoading();
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 7000); // Increased timeout for reading the detailed auth error
        }

        function alertMessage(title, message) {
            // Using the same error box for alerts but with a shorter display time
            errorDiv.innerHTML = `<strong>${title}:</strong> ${message}`;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // -------------------------------------------------------------------
        // 2. IMAGE HANDLING AND PREPROCESSING
        // -------------------------------------------------------------------
        
        function handleImageSelection(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    processImageButton.disabled = false;
                    resetDisplay(); // Reset fields when a new image is loaded
                };
                reader.readAsDataURL(file);
            } else {
                imagePreviewContainer.classList.add('hidden');
                imagePreview.src = '';
                processImageButton.disabled = true;
                resetDisplay();
            }
        }
        
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
            });
        }

        // -------------------------------------------------------------------
        // 3. GEMINI API CALL FOR STRUCTURED EXTRACTION (JSON ARRAY)
        // -------------------------------------------------------------------

        // NEW SCHEMA: Expects an array of card objects
        const structuredResponseSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "identifier": { "type": "STRING", "description": "The 15-digit code from the top of the card." },
                    "barcode_number": { "type": "STRING", "description": "The 17-digit number associated with the barcode." },
                    "expiry_date": { "type": "STRING", "description": "The expiration date in DD/MM/YY format." }
                },
                propertyOrdering: ["identifier", "barcode_number", "expiry_date"]
            }
        };

        const systemPrompt = "You are a specialized data extraction bot. Your task is to analyze the provided image, identify all individual cards (expected 1 to 4 cards), and extract exactly three specific pieces of information from EACH card as a valid JSON ARRAY of objects. For numbers, provide only the raw digits, no spaces. For the date, provide the DD/MM/YY format. If a value is not found on a specific card, use an empty string for that field in that card's object.";
        const userQuery = "Identify all cards in the image. For each card, extract the 15-digit identifier, the 17-digit barcode number, and the expiry date (DD/MM/YY). Return the results as a JSON array of objects.";


        window.processImageForNumbers = async function() {
            const file = imageFileInput.files[0];
            if (!file) return alertMessage("Missing Image", "Please capture or select an image first.");

            processImageButton.disabled = true;
            resetDisplay();
            showLoading("Analyzing image and extracting structured data...");

            try {
                const base64ImageData = await toBase64(file);
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userQuery },
                                {
                                    inlineData: {
                                        mimeType: file.type,
                                        data: base64ImageData
                                    }
                                }
                            ]
                        }
                    ],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: structuredResponseSchema
                    }
                };

                let response;
                let lastError = null;
                const maxRetries = 3;
                
                // Implement exponential backoff for API call
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(`${API_URL}?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - ${await response.text()}`);
                        }
                        break; // Exit loop on success
                    } catch (error) {
                        lastError = error;
                        // console.error(`Attempt ${i + 1} failed:`, error.message); // Silent retry
                        if (i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw lastError; // Throw final error
                        }
                    }
                }
                
                const result = await response.json();
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText) {
                    throw new Error("AI returned no content. Response JSON: " + JSON.stringify(result));
                }

                // Parse the array response
                let dataArray = JSON.parse(jsonText);
                
                // Ensure dataArray is actually an array (in case model outputs a single object)
                if (!Array.isArray(dataArray)) {
                    dataArray = [dataArray];
                }

                // Process and validate each card in the array
                const validatedCards = dataArray.map(data => {
                    // Basic data cleaning and validation
                    data.identifier = (data.identifier || '').replace(/[^0-9]/g, '').trim();
                    data.barcode_number = (data.barcode_number || '').replace(/[^0-9]/g, '').trim();
                    data.expiry_date = (data.expiry_date || '').trim();

                    // Add a simple status flag for filtering later if needed
                    // A card is considered 'valid' if at least one key field is extracted
                    data.isValid = data.identifier.length === 15 || data.barcode_number.length === 17 || data.expiry_date.length > 0;
                    return data;
                }).filter(card => card.isValid); // Only keep cards where at least one field was found

                // Update state and display
                extractedData = validatedCards; // extractedData is now an array
                const cardCount = extractedData.length;
                
                displayCardCount.textContent = `${cardCount}`;

                if (cardCount > 0) {
                    saveExtractedButton.disabled = false;
                    saveCountSpan.textContent = cardCount;
                    displayStatus.textContent = `Found and validated ${cardCount} card(s). Ready to save them all.`;
                    alertMessage("Success", `Found and validated ${cardCount} card(s). Ready to save.`);
                } else {
                    displayStatus.textContent = 'No valid card data was extracted.';
                    alertMessage("No Data Found", "Could not extract any valid card data from the image.");
                }

            } catch (e) {
                console.error("API or processing error: ", e);
                displayError("Failed to extract data. Check console for details.");
            } finally {
                processImageButton.disabled = false;
                processImageButton.textContent = '2. Extract ALL Cards (Identifier, Barcode, Date)';
                hideLoading();
            }
        }

        // -------------------------------------------------------------------
        // 4. FIRESTORE OPERATIONS
        // -------------------------------------------------------------------

        // Helper to get the correct collection path
        function getCollectionRef() {
            if (!db || !userId) {
                console.error("Firestore or User ID is not ready.");
                return null;
            }
            // Private collection path: /artifacts/{appId}/users/{userId}/{collectionName}
            const path = `artifacts/${appId}/users/${userId}/extracted_card_data`; // Updated collection name
            return collection(db, path);
        }
        
        // Function to save all extracted numbers to Firestore (now handles an array)
        window.saveExtractedNumbers = async function() {
            if (!extractedData || extractedData.length === 0) {
                alertMessage("No Data", "No cards were extracted to save.");
                return;
            }
            
            if (!db) {
                displayError("Database is not configured. Cannot save data.");
                return;
            }
            
            const cardCount = extractedData.length;
            
            saveExtractedButton.disabled = true;
            saveExtractedButton.textContent = `Saving ${cardCount} card(s)...`;
            showLoading(`Saving ${cardCount} extracted cards to Firestore...`);

            try {
                const collectionRef = getCollectionRef();
                if (!collectionRef) return;
                
                let docsSaved = 0;
                
                // Loop through the array of extracted cards and save each one as a separate document
                for (const card of extractedData) {
                    const dataToSave = {
                        identifier: card.identifier,
                        barcode_number: card.barcode_number,
                        expiry_date: card.expiry_date,
                        
                        // --- SECURITY/AUDITING FIELDS ---
                        device_user_agent: deviceMetadata.userAgent,
                        device_resolution: deviceMetadata.screenResolution,
                        // ------------------------------------

                        timestamp: serverTimestamp(),
                        user: userId
                    };

                    await addDoc(collectionRef, dataToSave);
                    docsSaved++;
                }
                
                extractedData = null; // Clear state after saving
                resetDisplay();
                alertMessage("Success", `Successfully saved ${docsSaved} document(s).`);

            } catch (e) {
                console.error("Error adding documents: ", e);
                displayError("Could not save the data to the database. Check Firestore Rules!");
            } finally {
                saveExtractedButton.disabled = true;
                saveCountSpan.textContent = '0';
                saveExtractedButton.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v8"></path></svg>Save <span id="save-count">0</span> Card(s) to Firestore`;
                hideLoading();
            }
        }

        // Function to set up the real-time listener for the data
        function setupRealtimeListener() {
            const collectionRef = getCollectionRef();
            if (!collectionRef) return;

            const q = query(collectionRef);

            onSnapshot(q, (snapshot) => {
                hideLoading();
                
                recordedData = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    recordedData.push({
                        id: doc.id,
                        identifier: data.identifier,
                        barcode_number: data.barcode_number,
                        expiry_date: data.expiry_date,
                        device_user_agent: data.device_user_agent || 'N/A',
                        device_resolution: data.device_resolution || 'N/A',
                        // Ensure timestamp conversion is safe
                        timestamp: data.timestamp && typeof data.timestamp.toDate === 'function' ? data.timestamp.toDate() : new Date()
                    });
                });
                
                // Sort by timestamp descending (newest first)
                recordedData.sort((a, b) => b.timestamp - a.timestamp);

                renderData();
                updateExportButtonState();
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                hideLoading();
                // This usually indicates an error in Security Rules or connection
                displayError("Real-time data failed to load. Check Firebase Security Rules.");
            });
        }

        // -------------------------------------------------------------------
        // 5. UI RENDERING AND EXPORT
        // -------------------------------------------------------------------

        // Function to render the list of numbers
        function renderData() {
            numbersList.innerHTML = '';
            countSpan.textContent = recordedData.length;

            if (recordedData.length === 0) {
                numbersList.appendChild(emptyState);
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            recordedData.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex flex-col items-start bg-white p-4 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition duration-150 space-y-2';

                // Format the 15-digit code for readability (5-5-5)
                const rawIdentifier = String(item.identifier || 'N/A');
                const displayIdentifierFormatted = rawIdentifier.length === 15 
                    ? rawIdentifier.slice(0, 5) + ' ' + rawIdentifier.slice(5, 10) + ' ' + rawIdentifier.slice(10)
                    : rawIdentifier;
                    
                // Format the 17-digit code for readability (5-5-5-2)
                const rawBarcode = String(item.barcode_number || 'N/A');
                const displayBarcodeFormatted = rawBarcode.length > 5 
                    ? rawBarcode.slice(0, 5) + ' ' + rawBarcode.slice(5, 10) + ' ' + rawBarcode.slice(10, 15) + ' ' + rawBarcode.slice(15)
                    : rawBarcode;

                const formattedTime = item.timestamp.toLocaleString('en-US', {
                    month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                
                // NEW: Get concise OS name and combine with resolution for display
                const deviceOS = getConciseOS(item.device_user_agent);
                const osResolutionDisplay = `${deviceOS} \\ ${item.device_resolution}`;
                
                // Truncate User Agent for a title attribute (full detail on hover)
                const shortUserAgent = item.device_user_agent.length > 50 
                    ? item.device_user_agent.substring(0, 47) + '...' 
                    : item.device_user_agent;

                li.innerHTML = `
                    <div class="flex flex-col w-full">
                        <p class="text-xs text-gray-400 mb-1">ID | Barcode | Date | Device OS \\ Resolution</p>
                        <div class="flex flex-col md:flex-row md:justify-between w-full">
                            <p class="text-base font-mono text-gray-800 font-semibold break-all text-sm md:text-base">
                                <span>${displayIdentifierFormatted}</span> | 
                                <span>${displayBarcodeFormatted}</span> | 
                                <span class="text-emerald-600">${item.expiry_date || 'N/A'}</span>
                                <span class="text-gray-500 font-normal ml-2 md:ml-4">| ${osResolutionDisplay}</span>
                            </p>
                            <span class="text-xs text-gray-400 mt-2 md:mt-0">${formattedTime}</span>
                        </div>
                    </div>
                    <!-- Keeping the full user agent accessible via a hidden/small element for audit -->
                    <p class="text-xs text-gray-500 pt-1 w-full hidden md:block">
                        <span class="font-semibold">Full Agent:</span> 
                        <span title="${item.device_user_agent}" class="font-normal text-gray-400">${shortUserAgent}</span>
                    </p>
                `;
                numbersList.appendChild(li);
            });
        }

        function updateExportButtonState() {
            exportButton.disabled = recordedData.length === 0;
        }

        // --- CSV GENERATION ---
        function generateCSV() {
            if (recordedData.length === 0) return '';

            // ADDED NEW HEADERS
            const headers = [
                "Identifier (15-Digit)", 
                "Barcode Number (17-Digit)", 
                "Expiry Date (DD/MM/YY)", 
                "Timestamp", 
                "Device User Agent", 
                "Device Resolution", 
                "RecordID"
            ];
            let csv = headers.join(',') + '\n';

            recordedData.forEach(item => {
                // Ensure data is wrapped in quotes to handle commas/special characters if any exist
                const identifier = `"${item.identifier || ''}"`;
                const barcode = `"${item.barcode_number || ''}"`;
                const date = `"${item.expiry_date || ''}"`;
                const timestamp = `"${item.timestamp.toISOString()}"`;
                // DEVICE FIELDS
                const userAgent = `"${item.device_user_agent.replace(/"/g, '""') || ''}"`; // Escape double quotes within field
                const resolution = `"${item.device_resolution || ''}"`;

                const recordId = `"${item.id}"`;
                
                csv += [identifier, barcode, date, timestamp, userAgent, resolution, recordId].join(',') + '\n';
            });
            return csv;
        }

        // --- DIRECT DOWNLOAD FUNCTION (Updated) ---

        /**
         * Generates the CSV from recorded data and immediately triggers a file download.
         */
        window.triggerCSVDownload = function() {
            const currentCSVString = generateCSV();

            if (!currentCSVString) {
                alertMessage("Download Error", "No data recorded yet to download.");
                return;
            }
            
            const blob = new Blob([currentCSVString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            const dateStamp = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `ExtractedCardData_Export_${dateStamp}.csv`);
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up the object URL
            setTimeout(() => URL.revokeObjectURL(url), 100);

            alertMessage("Success", "CSV file download initiated!");
        }
        
    </script>
</body>
</html>
