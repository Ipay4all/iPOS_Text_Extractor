<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Card CSV Extractor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar styling for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #a7f3d0; /* emerald-200 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f3f4f6; /* gray-100 */
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the Save button text to adjust dynamically */
        #save-extracted-button span {
            display: inline-block;
            min-width: 1ch; /* Ensure space for the number */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="bg-white shadow-2xl rounded-xl w-full max-w-4xl p-6 md:p-10 transition-all duration-300">
        <h1 class="4xl font-extrabold text-emerald-600 mb-2">Multi-Card CSV Extractor</h1>
        <p class="text-gray-500 mb-6 border-b pb-4">Capture an image of cards to extract data and immediately download it as a CSV file.</p>

        <!-- Loading and Error Display -->
        <div id="error-message" class="text-center py-4 text-red-600 bg-red-100 rounded-lg hidden mb-4"></div>

        <!-- === 1. CAPTURE IMAGE BOX === -->
        <div class="flex flex-col gap-4 mb-4 p-4 border rounded-xl bg-emerald-50 shadow-inner">
            <h3 class="text-2xl font-bold text-emerald-700">1. Capture or Select Image</h3>
            
            <!-- File Input (accepts camera capture - KEY FOR MOBILE) -->
            <label for="image-file-input" class="cursor-pointer bg-white hover:bg-gray-50 text-emerald-700 font-semibold py-3 px-6 rounded-lg border border-emerald-300 shadow-md transition duration-150 flex items-center justify-center space-x-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.808-1.212A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.808 1.212a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>Tap to Open Camera or Select File</span>
            </label>
            <input type="file" id="image-file-input" accept="image/*" capture="camera" 
                   class="hidden">
            
            <!-- Image Preview -->
            <div id="image-preview-container" class="mt-2 hidden bg-gray-100 p-2 rounded-lg">
                <img id="image-preview" class="max-w-full h-auto rounded-lg shadow-lg max-h-64 object-contain mx-auto transition-opacity duration-300" alt="Image Preview">
            </div>
        </div>

        <!-- === 2. EXTRACT CARDS BUTTON (New Separate Box) === -->
        <div class="flex flex-col gap-4 mb-8">
            <button id="process-image-button" onclick="processImageForNumbers()" disabled
                    class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg shadow-xl transition duration-150 disabled:bg-gray-400 flex items-center justify-center text-lg">
                2. Extract ALL Cards (Identifier, Barcode, Date)
            </button>
            
            <!-- Loading Indicator for Image Processing -->
            <div id="loading-indicator" class="text-center py-2 text-emerald-500 hidden pt-2">
                <svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span id="loading-message">Initializing...</span>
            </div>
        </div>


        <!-- === 3. EXTRACTED DATA AREA === -->
        <!-- Added pt-6 and pb-3 to the h3 for extra vertical spacing -->
        <div id="extraction-result-area" class="mt-6 mb-8 p-4 border rounded-xl bg-gray-100 shadow-md">
            <h3 class="2xl font-bold text-gray-700 pt-6 pb-3">3. Extracted Cards Ready to Add to List</h3>
            <div id="extracted-display" class="min-h-[50px] p-3 bg-white border border-dashed border-gray-300 rounded-lg text-gray-600 whitespace-pre-wrap text-sm font-mono break-all space-y-2">
                <p><strong>Cards Found:</strong> <span id="display-card-count" class="font-mono text-gray-800 font-semibold">---</span></p>
                <p id="display-status" class="text-xs text-gray-500 italic">Extract an image to see results here.</p>
            </div>
            
            <button id="save-extracted-button" onclick="addExtractedCardsToLocalList()" disabled
                    class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150 disabled:bg-gray-400 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Add <span id="save-count">0</span> Card(s) to Local List
            </button>
        </div>


        <!-- Action and Status Area -->
        <div class="flex justify-between items-center mb-6 border-t pt-4">
            <h2 class="text-2xl font-bold text-gray-700">Local List (<span id="count">0</span>)</h2>
            
            <!-- Direct Download Button -->
            <button id="export-button" onclick="triggerCSVDownload()" disabled
                    class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 disabled:bg-gray-400 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Download CSV
            </button>
        </div>


        <!-- Data List -->
        <div id="numbers-list-container" class="bg-gray-100 p-4 rounded-lg max-h-96 overflow-y-auto custom-scrollbar border-t">
            <ul id="numbers-list" class="space-y-3">
                <li id="empty-state" class="text-gray-500 text-center py-4">No data added to the local list yet.</li>
            </ul>
        </div>
    </div>
    
    <!-- Application Logic -->
    <script>
        // --- GLOBAL CONSTANTS ---
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
        const apiKey = "AIzaSyAJ1QYHq_LbGeO23h1yxXN7dLE9QMvPFgc"; // Platform-injected key.

        // --- APP STATE ---
        let recordedData = []; // Main array to hold all data to be exported
        let extractedData = null; // Will temporarily hold the array of cards extracted from the last image
        
        // --- DOM ELEMENTS ---
        const imageFileInput = document.getElementById('image-file-input');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const processImageButton = document.getElementById('process-image-button');
        const saveExtractedButton = document.getElementById('save-extracted-button');
        const saveCountSpan = document.getElementById('save-count');
        const exportButton = document.getElementById('export-button');
        const numbersList = document.getElementById('numbers-list');
        const emptyState = document.getElementById('empty-state');
        const countSpan = document.getElementById('count');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingMessage = document.getElementById('loading-message');
        const errorDiv = document.getElementById('error-message');
        
        // Display Elements for Multi-Card summary
        const displayCardCount = document.getElementById('display-card-count');
        const displayStatus = document.getElementById('display-status');

        // Attach event listener for initial image selection
        imageFileInput.addEventListener('change', (e) => handleImageSelection(e));
        
        // --- INITIALIZATION ---
        
        function initializeApp() {
            renderData();
            updateExportButtonState();
        }

        function resetDisplay() {
            displayCardCount.textContent = '---';
            displayStatus.textContent = 'Extract an image to see results here.';
            saveExtractedButton.disabled = true;
            saveCountSpan.textContent = '0';
            extractedData = null; // Clear array
        }

        // --- DEVICE METADATA (Captured once, used for CSV) ---
        function getConciseOS(userAgent) {
            if (userAgent.match(/Android (\d+(\.\d+)?)/i)) { return 'Android'; }
            if (userAgent.match(/(iPhone|iPad).*OS (\d+_\d+)/i)) { return 'iOS'; }
            if (userAgent.match(/Windows NT (\d+\.\d+)/i)) { return 'Windows PC'; }
            if (userAgent.includes('Macintosh')) { return 'macOS'; }
            if (userAgent.includes('Linux')) { return 'Linux'; }
            return 'Unknown OS';
        }

        function captureDeviceMetadata() {
            const userAgent = navigator.userAgent;
            const screenResolution = `${window.screen.width}x${window.screen.height}`;
            const browserName = userAgent.includes('Chrome') ? 'Chrome' : userAgent.includes('Firefox') ? 'Firefox' : userAgent.includes('Safari') ? 'Safari' : 'Other';
            
            return {
                userAgent: userAgent,
                screenResolution: screenResolution,
                deviceOS: getConciseOS(userAgent),
                browserName: browserName,
                timestamp: new Date()
            };
        }
        
        // Utility Functions
        function showLoading(message) {
            loadingMessage.textContent = message;
            loadingIndicator.classList.remove('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        function displayError(message) {
            errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
            errorDiv.classList.remove('hidden');
            hideLoading();
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 7000); 
        }

        function alertMessage(title, message) {
            // Using the same error box for alerts but with a shorter display time
            errorDiv.classList.remove('bg-red-100', 'text-red-600');
            errorDiv.classList.add('bg-blue-100', 'text-blue-600');
            errorDiv.innerHTML = `<strong>${title}:</strong> ${message}`;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
                errorDiv.classList.remove('bg-blue-100', 'text-blue-600');
                errorDiv.classList.add('bg-red-100', 'text-red-600');
            }, 5000);
        }

        // -------------------------------------------------------------------
        // 1. IMAGE HANDLING AND PREPROCESSING
        // -------------------------------------------------------------------
        
        function handleImageSelection(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    processImageButton.disabled = false;
                    resetDisplay(); // Reset fields when a new image is loaded
                };
                reader.readAsDataURL(file);
            } else {
                imagePreviewContainer.classList.add('hidden');
                imagePreview.src = '';
                processImageButton.disabled = true;
                resetDisplay();
            }
        }
        
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
            });
        }

        // -------------------------------------------------------------------
        // 2. GEMINI API CALL FOR STRUCTURED EXTRACTION (JSON ARRAY)
        // -------------------------------------------------------------------

        // NEW SCHEMA: Expects an array of card objects
        const structuredResponseSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "identifier": { "type": "STRING", "description": "The 15-digit code from the top of the card." },
                    "barcode_number": { "type": "STRING", "description": "The 17-digit number associated with the barcode." },
                    "expiry_date": { "type": "STRING", "description": "The expiration date in DD/MM/YY format." }
                },
                propertyOrdering: ["identifier", "barcode_number", "expiry_date"]
            }
        };

        const systemPrompt = "You are a specialized data extraction bot. Your task is to analyze the provided image, identify all individual cards (expected 1 to 20 cards), and extract exactly three specific pieces of information from EACH card as a valid JSON ARRAY of objects. For numbers, provide only the raw digits, no spaces. For the date, provide the DD/MM/YY format. If a value is not found on a specific card, use an empty string for that field in that card's object.";
        const userQuery = "Identify all cards in the image. For each card, extract the 15-digit identifier, the 17-digit barcode number, and the expiry date (DD/MM/YY). Return the results as a JSON array of objects.";


        window.processImageForNumbers = async function() {
            const file = imageFileInput.files[0];
            if (!file) return alertMessage("Missing Image", "Please capture or select an image first.");

            processImageButton.disabled = true;
            resetDisplay();
            showLoading("Analyzing image and extracting structured data...");

            try {
                const base64ImageData = await toBase64(file);
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userQuery },
                                {
                                    inlineData: {
                                        mimeType: file.type,
                                        data: base64ImageData
                                    }
                                }
                            ]
                        }
                    ],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: structuredResponseSchema
                    }
                };

                let response;
                let lastError = null;
                const maxRetries = 3;
                
                // Implement exponential backoff for API call
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(`${API_URL}?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - ${await response.text()}`);
                        }
                        break; // Exit loop on success
                    } catch (error) {
                        lastError = error;
                        // console.error(`Attempt ${i + 1} failed:`, error.message); // Silent retry
                        if (i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw lastError; // Throw final error
                        }
                    }
                }
                
                const result = await response.json();
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText) {
                    throw new Error("AI returned no content. Response JSON: " + JSON.stringify(result));
                }

                // Parse the array response
                let dataArray = JSON.parse(jsonText);
                
                // Ensure dataArray is actually an array (in case model outputs a single object)
                if (!Array.isArray(dataArray)) {
                    dataArray = [dataArray];
                }

                // Process and validate each card in the array
                const validatedCards = dataArray.map(data => {
                    // Basic data cleaning and validation
                    data.identifier = (data.identifier || '').replace(/[^0-9]/g, '').trim();
                    data.barcode_number = (data.barcode_number || '').replace(/[^0-9]/g, '').trim();
                    data.expiry_date = (data.expiry_date || '').trim();

                    // A card is considered 'valid' if at least one key field is extracted
                    data.isValid = data.identifier.length === 15 || data.barcode_number.length === 17 || data.expiry_date.length > 0;
                    return data;
                }).filter(card => card.isValid); // Only keep cards where at least one field was found

                // Update state and display
                extractedData = validatedCards; // extractedData is now an array
                const cardCount = extractedData.length;
                
                displayCardCount.textContent = `${cardCount}`;

                if (cardCount > 0) {
                    saveExtractedButton.disabled = false;
                    saveCountSpan.textContent = cardCount;
                    displayStatus.textContent = `Found and validated ${cardCount} card(s). Click 'Add' to include them in the local list.`;
                    alertMessage("Success", `Found and validated ${cardCount} card(s). Ready to add.`);
                } else {
                    displayStatus.textContent = 'No valid card data was extracted.';
                    alertMessage("No Data Found", "Could not extract any valid card data from the image.");
                }

            } catch (e) {
                console.error("API or processing error: ", e);
                displayError("Failed to extract data. Check console for details.");
            } finally {
                processImageButton.disabled = false;
                hideLoading();
            }
        }

        // -------------------------------------------------------------------
        // 3. LOCAL DATA MANAGEMENT
        // -------------------------------------------------------------------

        // Function to add extracted cards to the local list
        window.addExtractedCardsToLocalList = function() {
            if (!extractedData || extractedData.length === 0) {
                alertMessage("No Data", "No cards were extracted to add.");
                return;
            }
            
            const cardCount = extractedData.length;
            const deviceMeta = captureDeviceMetadata();

            // Prepare cards for the local list, adding metadata
            const cardsToAdd = extractedData.map(card => ({
                ...card,
                ...deviceMeta, // Add all metadata fields
                // Generate a pseudo-ID for display/sorting (no need for real Firestore ID)
                id: crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2, 15), 
                timestamp: new Date()
            }));
            
            // Add to the main recorded data list
            recordedData.unshift(...cardsToAdd); // Add to the front to show newest first

            // Clear the temporary extracted data state
            extractedData = null;
            resetDisplay();
            
            // Re-render and update button states
            renderData();
            updateExportButtonState();

            alertMessage("Added", `Successfully added ${cardCount} card(s) to the local list!`);
        }
        
        // -------------------------------------------------------------------
        // 4. UI RENDERING AND EXPORT
        // -------------------------------------------------------------------

        // Function to render the list of numbers
        function renderData() {
            numbersList.innerHTML = '';
            countSpan.textContent = recordedData.length;

            if (recordedData.length === 0) {
                numbersList.appendChild(emptyState);
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            recordedData.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex flex-col items-start bg-white p-4 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition duration-150 space-y-2';

                // Format the 15-digit code for readability (5-5-5)
                const rawIdentifier = item.identifier || 'N/A';
                const displayIdentifierFormatted = rawIdentifier.length === 15 
                    ? rawIdentifier.slice(0, 5) + ' ' + rawIdentifier.slice(5, 10) + ' ' + rawIdentifier.slice(10)
                    : rawIdentifier;
                    
                // Format the 17-digit code for readability (5-5-5-2)
                const rawBarcode = item.barcode_number || 'N/A';
                const displayBarcodeFormatted = rawBarcode.length > 5 
                    ? rawBarcode.slice(0, 5) + ' ' + rawBarcode.slice(5, 10) + ' ' + rawBarcode.slice(10, 15) + ' ' + rawBarcode.slice(15)
                    : rawBarcode;

                const formattedTime = item.timestamp.toLocaleString('en-US', {
                    month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                
                // NEW: Use concise OS and combine with resolution for display
                const osResolutionDisplay = `${item.deviceOS || 'Unknown'} \\ ${item.screenResolution || 'N/A'}`;
                
                li.innerHTML = `
                    <div class="flex flex-col w-full">
                        <p class="text-xs text-gray-400 mb-1">ID | Barcode | Date | Device OS \\ Resolution</p>
                        <div class="flex flex-col md:flex-row md:justify-between w-full">
                            <p class="text-base font-mono text-gray-800 font-semibold break-all text-sm md:text-base">
                                <span>${displayIdentifierFormatted}</span> | 
                                <span>${displayBarcodeFormatted}</span> | 
                                <span class="text-emerald-600">${item.expiry_date || 'N/A'}</span>
                                <span class="text-gray-500 font-normal ml-2 md:ml-4">| ${osResolutionDisplay}</span>
                            </p>
                            <span class="text-xs text-gray-400 mt-2 md:mt-0">${formattedTime}</span>
                        </div>
                    </div>
                `;
                numbersList.appendChild(li);
            });
        }

        function updateExportButtonState() {
            exportButton.disabled = recordedData.length === 0;
        }

        // --- CSV GENERATION ---
        function generateCSV() {
            if (recordedData.length === 0) return '';

            // Updated headers to reflect the new device metadata structure
            const headers = [
                "Identifier (15-Digit)", 
                "Barcode Number (17-Digit)", 
                "Expiry Date (DD/MM/YY)", 
                "Timestamp", 
                "Device OS", 
                "Browser Name",
                "Screen Resolution", 
                "Device User Agent",
                "Local Record ID"
            ];
            let csv = headers.join(',') + '\n';

            recordedData.forEach(item => {
                // Helper to ensure data is quoted and cleaned for CSV
                const clean = (data) => `"${(data || '').toString().replace(/"/g, '""')}"`;
                
                const dataRow = [
                    clean(item.identifier),
                    clean(item.barcode_number),
                    clean(item.expiry_date),
                    clean(item.timestamp.toISOString()),
                    
                    // Device Metadata fields
                    clean(item.deviceOS),
                    clean(item.browserName),
                    clean(item.screenResolution),
                    clean(item.userAgent),

                    clean(item.id)
                ];
                
                csv += dataRow.join(',') + '\n';
            });
            return csv;
        }

        // --- DIRECT DOWNLOAD FUNCTION ---
        window.triggerCSVDownload = function() {
            const currentCSVString = generateCSV();

            if (!currentCSVString) {
                alertMessage("Download Error", "No data recorded yet to download.");
                return;
            }
            
            const blob = new Blob([currentCSVString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            const dateStamp = new Date().toISOString().slice(0, 10).replace(/-/g, ''); // e.g., 20251022
            link.setAttribute("download", `ExtractedCardData_Export_${dateStamp}.csv`);
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up the object URL
            setTimeout(() => URL.revokeObjectURL(url), 100);

            alertMessage("Success", "CSV file download initiated! You can now share it.");
        }
        
        // Start the application logic
        initializeApp();
    </script>
</body>
</html>

